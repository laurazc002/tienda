define(["ytos.domlib"],function(a){"use strict";return yTos.utils.namespace("yTos.tracking.TagCommander"),yTos.tracking.TagCommander=yTos.helpers.base.extend({loadedTagCommanderScripts:!1,formatPrice:function(a,b,c,d){var e=a;b=isNaN(b=Math.abs(b))?2:b,c=void 0===c?",":c,d=void 0===d?".":d;var f=e<0?"-":"",g=parseInt(e=Math.abs(+e||0).toFixed(b),10)+"",h=(h=g.length)>3?h%3:0;return f+(h?g.substr(0,h)+d:"")+g.substr(h).replace(/(\d{3})(?=\d)/g,"$1"+d)+(b?c+Math.abs(e-g).toFixed(b).slice(2):"")},initialize:function(){this.options.enableEventsTracking&&yTos.tracking.registerDriver("TC",this),yTos.configuration.dataLayer&&this.extendDataLayer(),$Y.watch({"yTos::Search::ProductsReady":this.updateSrItems.bind(this)})},globalMessages:{"yTos::UserDataLayerInitialized":"extendDataLayer","yTos::Search::filterAdded":"updateSearchFiltersValues","yTos::Item::QuickBuyLayerHtmlReady":"setQuickBuyOpened","yTos::ItemsListUpdated":"updateItemsList","yTos::Search::ProductsReady":"onSearchProductsReady","yTos::Item::RecentlyViewedHTMLReady":"updateItemsList","yTos::Item::RenderRelatedItemsLoaded":"updateItemsList","yTos::Item::RenderRelatedItemsUpdated":"updateItemsList","yTos::Checkout::PickupShippingAddressFormSuccess":"setPickup","yTos::Checkout::UpsShippingAddressFormSuccess":"resetPickup","yTos::Checkout::ShippingAddressFormSuccess":"resetPickup","yTos::Checkout::SetShippingAddressByIdSuccess":"resetPickup","yTos::Tracking::PaymentMethodChanged":"updatePaymentMethod"},updatePaymentMethod:function(a){this.extendTcVars({cart_PaymentType:a.value})},setPickup:function(){this.extendTcVars({cart_ispickupinstoreselected:!0})},resetPickup:function(){this.extendTcVars({cart_ispickupinstoreselected:!1})},setQuickBuyOpened:function(){this.extendTcVars({env_template:"item",nav_section:"cts",nav_pagetype:"item"})},updateSearchFiltersValues:function(a){var b={};switch(a.key){case"color":b.sr_color=a.value;break;case"size":b.sr_size=a.value}this.extendTcVars(b),this.extendDataLayerWithSrProps(a.key),this.loadTagCommanderScripts()},updateSrItems:function(){window.tc_vars.sr_items={};var b={},c=[];a("[data-ytos-item-code10], [data-ytos-item]").each(function(b,d){var e=a(d),f=e.data("ytosItemCode10")||e.data("ytosItem"),g=e.data("ytosTrackProductData")||{},h=this.formatPrice(g.product_price,2,".",","),i=this.formatPrice(g.product_discountedPrice,2,".",","),j=this.formatPrice(g.product_price_tf,2,".",","),k=this.formatPrice(g.product_discountedPrice_tf,2,".",","),l=e.find('[itemprop="title"]'),m=l.length>0?l.get(0).innerText:"",n=e.find('[data-ytos-ctrl="item.modelName"]'),o=n.length>0?n.get(0).innerText:"",p=l.length>0?m:o;p=$Y.trim(p),c.push({sr_item_cod8:f.toString().substr(0,8),sr_item_cod10:f,sr_item_name:p,sr_item_unitprice_ati:h,sr_item_unitprice_tf:j,sr_item_discount_ati:i,sr_item_discount_tf:k,sr_item_quantity:"",sr_item_macro_category:g.product_macro_category,sr_item_macro_category_id:g.product_macro_category_id,sr_item_micro_category:g.product_micro_category,sr_item_micro_category_id:g.product_micro_category_id,sr_item_brand:g.product_brand,sr_item_color:g.product_color,sr_item_color_id:g.product_color_id,sr_item_position:g.product_position,sr_item_list:"searchresult",sr_item_is_in_stock:!g.hasOwnProperty("product_is_in_stock")||g.product_is_in_stock,product_variant_id:g.product_variant_id,product_id:g.product_id,product_legacy_macro_id:g.product_legacy_macro_id,product_legacy_micro_id:g.product_legacy_micro_id})}.bind(this)),b.sr_items=c,this.extendTcVars(b)},tryGetNewestItemsList:function(a,b){return Object.keys(a).reduce(function(c,d){var e=b&&b[d]?b[d].reduce(function(a,b){for(var c=0;c<a.length;c++)if(a[c].item_cod10===b.item_cod10)return a.splice(c,1),a;return a},a[d]):a[d];return e.length&&c.push(e),c},[])},onSearchProductsReady:function(){this.updateItemsList("TcVarsItemsListUpdated")},updateItemsList:function(a){a="string"==typeof a?a:"TcVarsItemsListUpdated";var b=$Y.safeGet(window,"tc_vars.itemsList");window.tc_vars.itemsList={};var c=this._prepareItemsList();this.extendTcVars({itemsList:c}),$Y.notify($Y.stringFormat("yTos::TagCommander::{0}",a));var d=this.tryGetNewestItemsList(c,b);if(0!==d.length&&"function"==typeof window.tc_events_19)try{return window.tc_events_19(this,a,{newestItemsList:d})}catch(e){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}",a,e.message),"error")}},_prepareItemsList:function(){var b={};return a("[data-ytos-track-product-data]").each(function(c,d){var e=a(d),f=e.data("ytosTrackProductData")||{},g=f.product_cod10||"",h=this.formatPrice(f.product_price,2,".",","),i=this.formatPrice(f.product_discountedPrice,2,".",","),j=this.formatPrice(f.product_price_tf,2,".",","),k=this.formatPrice(f.product_discountedPrice_tf,2,".",","),l=f.list?f.list:"searchresult";b[l]||(b[l]=[]),b[l].push({item_cod8:g.toString().substr(0,8),item_cod10:g,item_name:f.product_title,item_unitprice_ati:h,item_unitprice_tf:j,item_discount_ati:i,item_discount_tf:k,item_quantity:"",item_macro_category:f.product_macro_category,item_macro_category_id:f.product_macro_category_id,item_micro_category:f.product_micro_category,item_micro_category_id:f.product_micro_category_id,item_brand:f.product_brand,item_color:f.product_color,item_color_id:f.product_color_id,item_position:f.product_position,item_list:f.list,item_inpressionAdded:!1,item_is_in_stock:!f.hasOwnProperty("product_is_in_stock")||f.product_is_in_stock,product_variant_id:f.product_variant_id,product_id:f.product_id,product_legacy_macro_id:f.product_legacy_macro_id,product_legacy_micro_id:f.product_legacy_micro_id,is_rsi_product:f.is_rsi_product,rsi_product_tracking_url:f.rsi_product_tracking_url,product_eng_title:f.product_eng_title,product_eng_casematerial:f.product_eng_casematerial,product_eng_category:f.product_eng_category,product_eng_collection:f.product_eng_collection,product_eng_color:f.product_eng_color,product_eng_jewelmaterial:f.product_eng_jewelmaterial,product_eng_leathermaterial:f.product_eng_leathermaterial,product_eng_micro:f.product_eng_micro,product_eng_season_of_sale:f.product_eng_season_of_sale,product_eng_strapmaterial:f.product_eng_strapmaterial,product_eng_subcollection:f.product_eng_subcollection,product_engravable:f.product_engravable,product_embossable:f.product_embossable,product_adjustable:f.product_adjustable,product_collection:f.product_collection,product_subcollection:f.product_subcollection,product_mfPartNumber:f.product_mfPartNumber,product_defaultMfPartNumber:f.product_defaultMfPartNumber,product_casematerial:f.product_casematerial,product_jewelmaterial:f.product_jewelmaterial,product_leathermaterial:f.product_leathermaterial,product_strapmaterial:f.product_strapmaterial,product_sellable:f.product_sellable})}.bind(this)),b},extendDataLayerWithSrProps:function(a){var b={};yTos.search&&yTos.search.department&&"undefined"!=typeof a&&(b.nav_subsection=a,b.nav_page=a),this.updateSrItems(),this.updateItemsList("TcVarsItemsListUpdatedFilterAdded"),this.trackPromotionsImpressions(),this.extendTcVars(b)},extendDataLayer:function(){if(this.extendDataLayerWithSrProps(),yTos.configuration.dataLayer.nav_dept=(yTos.navigation.itemData||yTos.navigation).Gender||"X",yTos.configuration.dataLayer.nav_languageId=yTos.navigation.LangId,yTos.configuration.dataLayer.nav_languageCode=yTos.navigation.Language,this.extendTcVars(yTos.configuration.dataLayer),"function"==typeof yTos.configuration.dataLayerFilter)try{yTos.configuration.dataLayerFilter()}catch(a){yTos.debug.log("Error while processing yTos.configuration.dataLayerFilter","error")}this.loadTagCommanderScripts()},extendTcVars:function(b){a.extend(!0,window.tc_vars,b);for(var c in window.tc_vars)if(window.tc_vars.hasOwnProperty(c)){var d=window.tc_vars[c];null==d&&(window.tc_vars[c]="")}window.tc_vars&&""===window.tc_vars.nav_pagetype&&(window.tc_vars.nav_pagetype=this._getPageString()),this._setRsiStatus()},loadTagCommanderScripts:function(){this.loadedTagCommanderScripts||(this.loadedTagCommanderScripts=!0,this.options.fileName.forEach(function(a){a=a+"?t="+tc_vars.env_version,require([this.options.cdnBasePath+a],function(){this.notify("yTos::TagCommanderCalled")}.bind(this))}.bind(this)))},userAction:function(){return!1},_getPageString:function(){var a=yTos.navigation.Action,b=yTos.navigation.Controller;return"index"!==a?b+"."+a:b},_setRsiStatus:function(){window.tc_vars&&("search"===yTos.navigation.Controller?window.tc_vars.rsiUsed=yTos.search.rsiUsed:"item"===yTos.navigation.Controller&&yTos&&yTos.configuration&&yTos.configuration.dataLayer&&yTos.configuration.dataLayer.product_variant_id&&this._setRsiUsedFromLocalStorage(yTos.configuration.dataLayer.product_variant_id))},trackEvent:function(a,b){var c=a.length>0?a[0]:a;if("undefined"!=typeof c&&"undefined"!=typeof c.driver&&"TC"!==c.driver||"function"!=typeof window.tc_events_19)return!1;var d={category:(b?c.category:window.tc_vars.nav_GAsection+(c.suffix||""))||"-",event:c.event,label:c.label};(a.legacyId||window.tc_vars.product_cod8||window.tc_vars.product_cod10)&&(d.legacyId=a.legacyId||window.tc_vars.product_cod8||window.tc_vars.product_cod10),(a.mfPartNumber||window.tc_vars.product_mfPartNumber)&&(d.mfPartNumber=a.mfPartNumber||window.tc_vars.product_mfPartNumber),(a.defaultMfPartNumber||window.tc_vars.product_defaultMfPartNumber)&&(d.defaultMfPartNumber=a.defaultMfPartNumber||window.tc_vars.product_defaultMfPartNumber),a.dataSt&&(d.dataSt=a.dataSt);try{return window.tc_events_19(this,"univ",d)}catch(e){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}","univ",e.message),"error")}},trackProductData:function(a,b){var c=a.length>0?a[0]:a;if(this._addRsiItemToLocalStorage(c),"function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,b||"enh_prod",{pid:c.product_cod10,name:c.product_title,brand:c.product_brand,category:c.product_category,variant:c.product_color,price:c.product_price,price_tf:c.product_price_tf,discountedPrice:c.product_discountedPrice,discountedPrice_tf:c.product_discountedPrice_tf,quantity:c.product_quantity||1,coupon:c.product_coupon||"",position:c.product_position,list:c.list,product_variant_id:c.product_variant_id,product_id:c.product_id,legacy_micro_id:c.product_legacy_micro_id,legacy_macro_id:c.product_legacy_macro_id,prdid:c.product_cod8,prdname:c.product_eng_title,product_eng_casematerial:c.product_eng_casematerial,product_eng_category:c.product_eng_category,product_eng_collection:c.product_eng_collection,product_eng_color:c.product_eng_color,product_eng_jewelmaterial:c.product_eng_jewelmaterial,product_eng_leathermaterial:c.product_eng_leathermaterial,product_eng_micro:c.product_eng_micro,product_eng_season_of_sale:c.product_eng_season_of_sale,product_eng_strapmaterial:c.product_eng_strapmaterial,product_eng_subcollection:c.product_eng_subcollection,productLine:c.product_line,productCollection:c.product_collection,productSubcollection:c.product_subcollection,productEngravable:c.product_engravable,productEmbossable:c.product_embossable,productAdjustable:c.product_adjustable,product_mfPartNumber:c.product_mfPartNumber,product_defaultMfPartNumber:c.product_defaultMfPartNumber,prdavailability:c.product_is_in_stock,csematerial:c.product_casematerial,prdjewelrymaterial:c.product_jewelmaterial,prdstrapmaterial:c.product_strapmaterial,prdleathermaterial:c.product_leathermaterial,dataSt:c.dataSt})}catch(d){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}",b||"enh_prod",d.message),"error")}},_addRsiItemToLocalStorage:function(a){var b=$Y.storage.get("yTosVisitedRsiItems")||{};b[a.product_id]=a.is_rsi_product,$Y.storage.set("yTosVisitedRsiItems",b),this.notify("yTos::Seo::VisitedRsiItemsStorageSet")},_setRsiUsedFromLocalStorage:function(a){var b=$Y.storage.get("yTosVisitedRsiItems")||{};b.hasOwnProperty(a)&&(window.tc_vars.rsiUsed=b[a],$Y.storage.del("yTosVisitedRsiItems",a))},trackChangeColor:function(a){return this._trackItemAction("colorChanged",a)},trackAddItem:function(a){return this._trackItemAction("enh_addcart",a)},trackRemoveItem:function(a){return this._trackItemAction("enh_removecart",a)},_trackItemAction:function(a,b){var c=b.length>0?b[0]:b;if("function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,a,{pid:c.product_cod10,name:c.product_title,category:c.product_category,brand:c.product_brand,variant:c.product_color||"",price:c.product_price,discount_price:c.product_discount_price,price_ati:c.product_price_ati,discount_price_ati:c.product_discount_price_ati,quantity:c.product_quantity||1,product_variant_id:c.product_variant_id,product_id:c.product_id,legacy_micro_id:c.product_legacy_micro_id,legacy_macro_id:c.product_legacy_macro_id,prdid:c.product_cod8,prdname:c.product_eng_title,product_eng_casematerial:c.product_eng_casematerial,product_eng_category:c.product_eng_category,product_eng_collection:c.product_eng_collection,product_eng_color:c.product_eng_color,product_eng_jewelmaterial:c.product_eng_jewelmaterial,product_eng_leathermaterial:c.product_eng_leathermaterial,product_eng_micro:c.product_eng_micro,product_eng_season_of_sale:c.product_eng_season_of_sale,product_eng_strapmaterial:c.product_eng_strapmaterial,product_eng_subcollection:c.product_eng_subcollection,productLine:c.product_line,productCollection:c.product_collection,productSubcollection:c.product_subcollection,productEngravable:c.product_engravable,productEmbossable:c.product_embossable,productEngraved:c.product_engraved,productEmbossed:c.product_embossed,productAdjustable:c.product_adjustable,productAdjusted:c.product_adjusted,personalizationType:c.product_personalizationType,mfPartNumber:c.product_mfPartNumber,defaultMfPartNumber:c.product_defaultMfPartNumber,productAvailability:c.product_is_in_stock,productCaseMaterial:c.product_casematerial,productJewelryMaterial:c.product_jewelmaterial,productStrapMaterial:c.product_strapmaterial,productLeatherMaterial:c.product_leathermaterial,productSize:c.product_size,productSkuMfPartNumber:c.product_skuMfPartNumber,dataSt:c.dataSt})}catch(d){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}",a,d.message),"error")}},trackTransactionInEuro:function(a,b){return!1},trackTransactionWithStandardCurrency:function(a,b){return!1},_trackTransaction:function(a){return!1},_setCustomDimensions:function(){return!1},parseDataLayer:function(){return!1},trackPageView:function(a){return!1},trackPromotionsImpressions:function(){window.tc_vars.promos={};var b={},c=[];a("[data-ytos-track-promotions-data]").each(function(b,d){var e=a(d).data("ytos-track-promotions-data"),f={promotion_id:e.promotion_id,promotion_name:e.promotion_name,promotion_creative:e.promotion_creative,promotion_position:e.position};c.push(f)}.bind(this)),b.promos=c,this.extendTcVars(b),$Y.notify("yTos::TagCommander::TcVarsPromosListUpdated")},trackPromotionsClick:function(a){var b=a.length>0?a[0]:a;if("function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,"enh_trackPromotionClicks",{promotion_id:b.id,promotion_name:b.name,promotion_creative:b.creative,promotion_position:b.position})}catch(c){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}","enh_trackPromotionClicks",c.message),"error")}},trackVirtualPageView:function(a){var b=a.length>0?a[0]:a;if(window.tc_vars&&b&&(window.tc_vars.nav_stepName=b.stepName),"function"!=typeof window.tc_events_19)return!1;try{return window.tc_events_19(this,"virtualPageView",{stepName:b.stepName})}catch(c){yTos.debug.log($Y.stringFormat("Error while processing {0}: {1}","virtualPageView",c.message),"error")}}}),yTos.tracking.TagCommander});